<script>
document.addEventListener('DOMContentLoaded', () => {

/* =========================
   SAFE HELPERS
========================= */
const $ = id => document.getElementById(id);

/* =========================
   STATE
========================= */
let cart = JSON.parse(localStorage.getItem('cart')) || [];

/* =========================
   PRODUCTS
========================= */
const products = [
  {id:1, name:'iPhone 15 Pro', price:119990},
  {id:2, name:'iPhone 15', price:89990},
  {id:3, name:'iPhone 14', price:74990}
];

/* =========================
   CART CORE
========================= */
window.addToCart = function(product){
  if(!product) return;

  let item = cart.find(i => i.id === product.id);
  if(item) item.qty++;
  else cart.push({ ...product, qty:1 });

  saveCart();
  fly();
  openCart();
}

function saveCart(){
  localStorage.setItem('cart', JSON.stringify(cart));
  updateBadge();
}

function updateBadge(){
  if($('count')){
    $('count').innerText = cart.reduce((s,i)=>s+i.qty,0);
  }
}

/* =========================
   CART UI
========================= */
window.openCart = function(){
  if(!$('cart') || !$('items')) return;

  $('items').innerHTML = '';

  if(cart.length === 0){
    $('items').innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
  } else {
    cart.forEach((i,idx)=>{
      $('items').innerHTML += `
        <div style="margin-bottom:16px">
          <b>${i.name}</b><br>
          ${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}
          <div style="margin-top:8px">
            <button onclick="changeQty(${idx},1)">+</button>
            <button onclick="changeQty(${idx},-1)">‚àí</button>
            <button onclick="removeItem(${idx})">‚úï</button>
          </div>
        </div>
      `;
    });

    $('items').innerHTML += `
      <hr>
      <b>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</b>
    `;
  }

  $('cart').style.display = 'flex';
}

window.closeCart = function(){
  if($('cart')) $('cart').style.display = 'none';
}

window.changeQty = function(i,d){
  if(!cart[i]) return;
  cart[i].qty += d;
  if(cart[i].qty <= 0) cart.splice(i,1);
  saveCart();
  openCart();
}

window.removeItem = function(i){
  if(!cart[i]) return;
  cart.splice(i,1);
  saveCart();
  openCart();
}

function total(){
  return cart.reduce((s,i)=>s+i.price*i.qty,0);
}

/* =========================
   CHECKOUT (APPLE STYLE)
========================= */
window.finish = function(){
  if(!$('items')) return;

  const orderId = 'APL-' + Math.floor(Math.random()*1000000);
  const date = new Date().toLocaleString();

  $('items').innerHTML = `
    <h2 style="text-align:center">–°–ø–∞—Å–∏–±–æ üçé</h2>
    <p style="text-align:center;color:#888">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω</p>
    <hr>
    <p><b>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</b> ${orderId}</p>
    <p><b>–î–∞—Ç–∞:</b> ${date}</p>
    <hr>
    ${cart.map(i=>`
      <p>${i.name}<br>${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}</p>
    `).join('')}
    <hr>
    <h3>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</h3>
    <p style="color:#888">–û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∂–µ</p>
    <button onclick="location.reload()" style="width:100%">
      –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
    </button>
  `;

  cart = [];
  localStorage.removeItem('cart');
  updateBadge();
}

/* =========================
   FLY ANIMATION (SAFE)
========================= */
function fly(){
  const img = document.querySelector('.hero img');
  const cartBtn = $('cartBtn');
  if(!img || !cartBtn) return;

  const c = img.cloneNode(true);
  const r1 = img.getBoundingClientRect();
  const r2 = cartBtn.getBoundingClientRect();

  Object.assign(c.style,{
    position:'fixed',
    left:r1.left+'px',
    top:r1.top+'px',
    width:'120px',
    transition:'1s cubic-bezier(.4,0,.2,1)',
    zIndex:9999
  });

  document.body.appendChild(c);

  requestAnimationFrame(()=>{
    c.style.left = r2.left+'px';
    c.style.top = r2.top+'px';
    c.style.transform = 'scale(.1)';
    c.style.opacity = '0';
  });

  setTimeout(()=>c.remove(),1000);
}

/* =========================
   PWA SAFE
========================= */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}

/* =========================
   INIT
========================= */
updateBadge();

});
</script>
