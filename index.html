<script>
document.addEventListener('DOMContentLoaded', () => {

/* =========================
   SAFE HELPERS
========================= */
const $ = id => document.getElementById(id);

/* =========================
   DATA
========================= */
const PRODUCTS = {
  1:{id:1,name:'iPhone 15 Pro',price:119990},
  2:{id:2,name:'iPhone 15',price:89990},
  3:{id:3,name:'iPhone 14',price:74990}
};

let cart = JSON.parse(localStorage.getItem('cart')) || [];

/* =========================
   CART CORE
========================= */
window.addToCart = function(product){
  if(!product) return;
  let item = cart.find(i=>i.id===product.id);
  if(item) item.qty++;
  else cart.push({...product,qty:1});
  save();
  fly();
  openCart();
}

function save(){
  localStorage.setItem('cart',JSON.stringify(cart));
  if($('count')) $('count').innerText =
    cart.reduce((s,i)=>s+i.qty,0);
}

/* =========================
   CART UI
========================= */
window.openCart = function(){
  if(!$('cart') || !$('items')) return;
  $('items').innerHTML = '';

  if(cart.length===0){
    $('items').innerHTML='<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
  } else {
    cart.forEach((i,idx)=>{
      $('items').innerHTML+=`
        <div style="margin-bottom:14px">
          <b>${i.name}</b><br>
          ${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}
          <div>
            <button onclick="qty(${idx},1)">+</button>
            <button onclick="qty(${idx},-1)">‚àí</button>
          </div>
        </div>`;
    });
    $('items').innerHTML+=`
      <hr><b>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</b>`;
  }
  $('cart').style.display='flex';
}

window.closeCart = function(){
  if($('cart')) $('cart').style.display='none';
}

window.qty = function(i,d){
  if(!cart[i]) return;
  cart[i].qty+=d;
  if(cart[i].qty<=0) cart.splice(i,1);
  save(); openCart();
}

function total(){
  return cart.reduce((s,i)=>s+i.price*i.qty,0);
}

/* =========================
   CHECKOUT (APPLE)
========================= */
window.checkout = function(){
  if(!$('items')) return;
  const id='APL-'+Math.floor(Math.random()*999999);
  const date=new Date().toLocaleString();

  $('items').innerHTML=`
    <h2>–°–ø–∞—Å–∏–±–æ üçé</h2>
    <p style="color:#888">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω</p>
    <hr>
    <p><b>–ù–æ–º–µ—Ä:</b> ${id}</p>
    <p><b>–î–∞—Ç–∞:</b> ${date}</p>
    <hr>
    ${cart.map(i=>`
      <p>${i.name}<br>${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}</p>
    `).join('')}
    <hr>
    <h3>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</h3>
    <p style="color:#888">–û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∂–µ</p>
    <button onclick="location.reload()" style="width:100%">
      –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
    </button>
  `;
  cart=[]; save();
}

/* =========================
   FLY TO CART
========================= */
function fly(){
  const img=document.querySelector('.hero img, .product img');
  const cartBtn=$('cartBtn');
  if(!img||!cartBtn) return;

  const c=img.cloneNode(true);
  const a=img.getBoundingClientRect();
  const b=cartBtn.getBoundingClientRect();

  Object.assign(c.style,{
    position:'fixed',
    left:a.left+'px',
    top:a.top+'px',
    width:'120px',
    transition:'1s cubic-bezier(.4,0,.2,1)',
    zIndex:9999
  });

  document.body.appendChild(c);
  requestAnimationFrame(()=>{
    c.style.left=b.left+'px';
    c.style.top=b.top+'px';
    c.style.transform='scale(.1)';
    c.style.opacity='0';
  });
  setTimeout(()=>c.remove(),1000);
}

/* =========================
   REVEAL ANIMATIONS
========================= */
if('IntersectionObserver'in window){
  document.querySelectorAll('.reveal').forEach(el=>{
    new IntersectionObserver(e=>{
      if(e[0].isIntersecting) el.classList.add('show');
    },{threshold:.3}).observe(el);
  });
}

/* =========================
   PRODUCT PAGE LOGIC
========================= */
const pid=new URLSearchParams(location.search).get('id');
if(pid && PRODUCTS[pid]){
  if($('pName')) $('pName').innerText=PRODUCTS[pid].name;
  if($('pPrice')) $('pPrice').innerText=
    PRODUCTS[pid].price.toLocaleString()+' ‚ÇΩ';
  window.addProduct=function(){
    addToCart(PRODUCTS[pid]);
  }
}

/* =========================
   INIT
========================= */
save();

});
</script>
