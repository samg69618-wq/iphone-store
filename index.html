<script>
/* =========================
   STATE
========================= */
let cart = JSON.parse(localStorage.getItem('cart')) || [];

let product = {
  name: 'iPhone 15 Pro',
  color: '–¢–∏—Ç–∞–Ω–æ–≤—ã–π',
  storage: 128,
  basePrice: 119990
};

/* =========================
   PRICE
========================= */
function calcPrice(){
  let extra = product.storage === 256 ? 20000 :
              product.storage === 512 ? 40000 : 0;
  return product.basePrice + extra;
}

function updatePriceUI(){
  const el = document.getElementById('price');
  if (el) el.innerText = calcPrice().toLocaleString() + ' ‚ÇΩ';
}

/* =========================
   CONFIG
========================= */
function setColor(btn,val){
  product.color = val;
  btn.parentElement.querySelectorAll('button')
    .forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function setStorage(btn,val){
  product.storage = val;
  btn.parentElement.querySelectorAll('button')
    .forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  updatePriceUI();
}

/* =========================
   CART LOGIC
========================= */
function addToCart(){
  let item = cart.find(i =>
    i.name===product.name &&
    i.color===product.color &&
    i.storage===product.storage
  );

  if(item){
    item.qty++;
  } else {
    cart.push({
      name: product.name,
      color: product.color,
      storage: product.storage,
      price: calcPrice(),
      qty: 1
    });
  }

  saveCart();
  animateAdd();
  openCart();
}

function saveCart(){
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
}

function updateCartCount(){
  const el=document.getElementById('count');
  if(el) el.innerText = cart.reduce((s,i)=>s+i.qty,0);
}

/* =========================
   CART UI
========================= */
function openCart(){
  const box=document.getElementById('items');
  box.innerHTML='';

  if(cart.length===0){
    box.innerHTML='<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
  } else {
    cart.forEach((i,idx)=>{
      box.innerHTML+=`
      <div style="margin-bottom:16px">
        <b>${i.name}</b><br>
        ${i.color}, ${i.storage} –ì–ë<br>
        ${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}
        <div>
          <button onclick="changeQty(${idx},1)">+</button>
          <button onclick="changeQty(${idx},-1)">‚àí</button>
          <button onclick="removeItem(${idx})">‚úï</button>
        </div>
      </div>`;
    });
    box.innerHTML+=`<hr><b>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</b>`;
  }

  document.getElementById('cart').style.display='flex';
}

function closeCart(){
  document.getElementById('cart').style.display='none';
}

function changeQty(i,delta){
  cart[i].qty+=delta;
  if(cart[i].qty<=0) cart.splice(i,1);
  saveCart();
  openCart();
}

function removeItem(i){
  cart.splice(i,1);
  saveCart();
  openCart();
}

function total(){
  return cart.reduce((s,i)=>s+i.price*i.qty,0);
}

/* =========================
   CHECKOUT
========================= */
function finish(){
  document.getElementById('items').innerHTML=`
    <h3>–°–ø–∞—Å–∏–±–æ üçé</h3>
    <p>–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω</p>
    <p>–°—É–º–º–∞: ${total().toLocaleString()} ‚ÇΩ</p>
  `;
  cart=[];
  localStorage.removeItem('cart');
  updateCartCount();
}

/* =========================
   ANIMATION
========================= */
function animateAdd(){
  const badge=document.getElementById('count');
  badge.style.transform='scale(1.4)';
  setTimeout(()=>badge.style.transform='scale(1)',200);
}

/* =========================
   SCROLL EFFECTS
========================= */
const obs=new IntersectionObserver(e=>{
  e.forEach(x=>x.isIntersecting&&x.target.classList.add('show'));
},{threshold:.3});
document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));

window.addEventListener('scroll',()=>{
  const p=document.getElementById('heroPhone');
  if(p) p.style.transform=`translateY(${scrollY*0.15}px)`;
});

/* =========================
   INIT
========================= */
updatePriceUI();
updateCartCount();
</script>
