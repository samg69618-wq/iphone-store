<script>
/* =========================
   SAFE SELECTOR
========================= */
function $(id){ return document.getElementById(id); }

/* =========================
   DATA
========================= */
let cart = JSON.parse(localStorage.getItem('cart')) || [];

const products = [
  {id:1, name:'iPhone 15 Pro', price:119990, img:'iphone.png'},
  {id:2, name:'iPhone 15', price:89990, img:'iphone.png'},
  {id:3, name:'iPhone 14', price:74990, img:'iphone.png'}
];

/* =========================
   CART CORE
========================= */
function addToCart(product){
  let item = cart.find(i => i.id === product.id);
  if(item){
    item.qty++;
  } else {
    cart.push({
      id: product.id,
      name: product.name,
      price: product.price,
      qty: 1
    });
  }
  saveCart();
  flyToCart();
  openCart();
}

function saveCart(){
  localStorage.setItem('cart', JSON.stringify(cart));
  updateBadge();
}

function updateBadge(){
  if($('count')){
    $('count').innerText = cart.reduce((s,i)=>s+i.qty,0);
  }
}

/* =========================
   CART UI
========================= */
function openCart(){
  if(!$('cart') || !$('items')) return;

  $('items').innerHTML = '';

  if(cart.length === 0){
    $('items').innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
  } else {
    cart.forEach((i,idx)=>{
      $('items').innerHTML += `
        <div style="margin-bottom:16px">
          <b>${i.name}</b><br>
          ${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}
          <div style="margin-top:8px">
            <button onclick="changeQty(${idx},1)">+</button>
            <button onclick="changeQty(${idx},-1)">‚àí</button>
            <button onclick="removeItem(${idx})">‚úï</button>
          </div>
        </div>
      `;
    });

    $('items').innerHTML += `
      <hr>
      <b>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</b>
    `;
  }

  $('cart').style.display = 'flex';
}

function closeCart(){
  if($('cart')) $('cart').style.display = 'none';
}

function changeQty(i,d){
  if(!cart[i]) return;
  cart[i].qty += d;
  if(cart[i].qty <= 0) cart.splice(i,1);
  saveCart();
  openCart();
}

function removeItem(i){
  if(!cart[i]) return;
  cart.splice(i,1);
  saveCart();
  openCart();
}

function total(){
  return cart.reduce((s,i)=>s+i.price*i.qty,0);
}

/* =========================
   CHECKOUT (APPLE STYLE)
========================= */
function finish(){
  if(!$('items')) return;

  const orderId = 'APL-' + Math.floor(Math.random()*1000000);
  const date = new Date().toLocaleString();

  $('items').innerHTML = `
    <h2 style="text-align:center">–°–ø–∞—Å–∏–±–æ üçé</h2>
    <p style="text-align:center;color:#888">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω</p>
    <hr>
    <p><b>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</b> ${orderId}</p>
    <p><b>–î–∞—Ç–∞:</b> ${date}</p>
    <hr>
    ${cart.map(i=>`
      <p>${i.name}<br>
      ${i.price.toLocaleString()} ‚ÇΩ √ó ${i.qty}</p>
    `).join('')}
    <hr>
    <h3>–ò—Ç–æ–≥–æ: ${total().toLocaleString()} ‚ÇΩ</h3>
    <p style="color:#888">–û–ø–ª–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∂–µ</p>
    <button onclick="location.reload()" style="width:100%">
      –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
    </button>
  `;

  cart = [];
  localStorage.removeItem('cart');
  updateBadge();
}

/* =========================
   FLY TO CART ANIMATION
========================= */
function flyToCart(){
  const img = document.querySelector('.hero img');
  const cartBtn = document.querySelector('#cartBtn');
  if(!img || !cartBtn) return;

  const clone = img.cloneNode(true);
  const r1 = img.getBoundingClientRect();
  const r2 = cartBtn.getBoundingClientRect();

  clone.style.position = 'fixed';
  clone.style.left = r1.left + 'px';
  clone.style.top = r1.top + 'px';
  clone.style.width = '120px';
  clone.style.transition = '1s cubic-bezier(.4,0,.2,1)';
  clone.style.zIndex = 9999;

  document.body.appendChild(clone);

  requestAnimationFrame(()=>{
    clone.style.left = r2.left + 'px';
    clone.style.top = r2.top + 'px';
    clone.style.transform = 'scale(0.1)';
    clone.style.opacity = '0';
  });

  setTimeout(()=>clone.remove(),1000);
}

/* =========================
   PWA
========================= */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js');
}

/* =========================
   INIT
========================= */
updateBadge();
</script>
